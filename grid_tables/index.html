<!DOCTYPE html>
<html lang="en">

<head>
  <title>Grew stats</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- JQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <!-- Bootstrap 4 and Cie -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
  <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

  <!-- Remarkable -->
  <script src="https://cdn.jsdelivr.net/remarkable/1.7.1/remarkable.min.js"></script>

  <!-- Grid.js -->
  <link href="https://unpkg.com/gridjs/dist/theme/mermaid.css" rel="stylesheet" />
  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>

  <script>
    var urlParams = new URLSearchParams(window.location.search);
    var current
    var grid
    var md = new Remarkable();

    $(document).ready(function() {
      if (urlParams.has('data')) {
        $.getJSON(urlParams.get('data') + ".json")
          .done(function(data) {
            current = data;
            fill_table(data.patterns, data.stats);
            $("#title").html(md.render(data.title));
          })
          .fail(function() {
            $("#wrapper").html(`<h1>Fail to load "${urlParams.get('data')}.json"<h1>`);
          })
      } else {
        $("#wrapper").html("<h1>This web page is expected a `data` GET argument!<h1>");
      }
    })

    function fill_table(patterns, stats) {
      function add_users (col) {
        col["name"] = col["name"] + " â®• "+ patterns[col["name"]]["users"]
        return col
      }
      grid = new gridjs.Grid({
        columns: 
          ["Corpus"] 
          .concat(Object.keys(patterns).map(build_col).map(add_users)),
        search: true,
        sort: true,
        fixedHeader: true,
        height: 'calc(100vh - 120px)',
        data: stats
      }).render(document.getElementById("wrapper"));
      post_grid();
    }

    function post_grid() {
      $(".gridjs-input").attr("placeholder", "Search");
    }


    function get_before_whitespace (s) {
      index = s.indexOf(' ');
      if (index == -1) {
        return s
      } else {
        return s.slice(0,index)
      }
    }

    function build_col(name) {
      return ({
        name: name,
        formatter: (cell, row) =>
          (cell == 0 ? "" : gridjs.html(`<a class="btn btn-success" onclick='grew_match("${row.cells[0].data}","${name}")'>${cell}</a>`))
      })
    }

    function grew_match(v, n) {
      let corpus = get_before_whitespace(v);
      pattern_lines = current.patterns[n]["code"];
      pattern = pattern_lines.join("\n");
      let get_param = "?corpus=" + corpus;
      get_param += "&pattern=" + encodeURIComponent(pattern);
      if (current.patterns[n]["key"] != undefined && current.patterns[n]["key"] != null) {
        get_param += "&clustering=" + encodeURIComponent(current.patterns[n]["key"]);
      }
      window.open('http://match.grew.fr' + get_param, '_blank');
    }
  </script>

  <style>
    td {
      text-align: center;
      vertical-align: middle;
    }

    td.gridjs-td {
      background-color: #DDD;
    }

    td.gridjs-td:hover {
      background-color: #CCC;
    }

    th.gridjs-th-sort .gridjs-th-content {
      width: 100%
    }

    .container, .container-lg, .container-md, .container-sm, .container-xl {
      max-width: 100%;
    }
  </style>
</head>

<body>
  <h2 id="title" style="text-align: center;"></h2>
  <div class="container">
    <div id="wrapper"></div>
  </div>
</body>

</html>
